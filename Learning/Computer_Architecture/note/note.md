# 哈工大计算机体系结构笔记

## 第一章-计算机体系结构的基本概念

### 1.1 计算机体系结构的概念

#### 1.1.1 存储程序计算机

![1700385634050](images/1700385634050.png)

四个组成部分：

- 运算器
- 存储器
- 输入输出设备
- 控制器

主要特点：

1. 以运算器为中心
2. 采用存储程序原理
3. 存储器是按地址访问的
4. 控制流由指令流产生
5. 指令由操作码和地址码组成
6. 数据以二进制编码表示

![1700385786309](images/1700385786309.png)

#### 1.1.2 计算机体系结构、组成和实现

计算机体系结构的概念由**阿姆道尔**于 1964 年首次明确：程序员所看到的计算机的属性，即概念性结构与功能特性。

对于通用寄存器型的机器，这些属性主要是指：

1. 数据表示
2. 寻址规则
3. 寄存器定义
4. 指令系统
5. 中断系统
6. 机器工作状态的定义和切换
7. 存储系统
8. 信息保护
9. I/O 结构

计算机体系结构包括以下三个方面：

1. 计算机指令系统 ISA
2. 计算机组成
3. 计算机硬件实现

#### 1.1.3 系列机和兼容

**系列机**：具有相同体系结构，但组成和实现不同的一系列不同型号的计算机系统

一种体系结构可以有多种组织、多种物理实现。

**软件兼容**：

- 系列机具有相同的体系结构，软件可以在系列计算机的各档机器上运行。
- 同一个软件可以不加修改地运行于体系结构相同的各档机器，而且它们所获得的结果一样，差别只在于有不同的运行时间。
- 兼容分为二进制级兼容、汇编级兼容、高级语言兼容、数据级兼容等等。

**兼容机**：不同厂家生产的具有相同体系结构的计算机

**兼容性**：

- 向上(下)兼容指的是按某档机器编制的程序，不加修改的就能运行于比它高(低)档的机器
- 向前(后)兼容指的是按某个时期投入市场的某种型号机器编制的程序，不加修改地就能运行于在它之前(后)投入市场的机器

![1700386991606](images/1700386991606.png)

**向下兼容和向后兼容**比向上兼容和向前兼容更重要

### 1.2 计算机体系结构的发展

#### 1.2.1 计算机的分代

一般认为到目前为止计算机已经发展了五代

![1700387141743](images/1700387141743.png)

计算机曾根据价格分为 5 个档次：巨型机、大型机、中型机、小型机、微型机。

![1700387281363](images/1700387281363.png)

技术和性能的“下移”。

新型体系结构的设计一方面是合理地增加计算机系统中硬件的功能比例、另一方面则是通过多种途径提高计算机体系结构中的并行性。

#### 1.2.2 软件的发展

最重要的发展趋势之一：程序和数据使用的存储器容量不断扩大。

1. 计算机语言和编译技术
2. 操作系统
3. 软件工具和中间件

#### 1.2.3 应用的发展

计算机技术和市场分为嵌入式计算机、掌上计算机、台式计算机、服务器、数据中心。

#### 1.2.4 相关核心产品技术的发展

1. 逻辑电路 摩尔定律
2. DRAM 单个 DRAM 模块的容量每年增加 25-40%，增速逐年下降。
3. 闪存 近几年，每年约 50-60%的速度增长，大约每两年翻一番，大量用于便携式设备。
4. 磁盘 从 04 年开始，大约每年增长 40%，约每 3 年翻一番。SSD 的成本的迅速下降。
5. 网络

#### 1.2.5 体系结构的发展

1. 分布的 I/O 处理能力
2. 保护的存储器空间
3. 存储器组织结构的发展
4. 并行处理技术
5. 指令集的发展

#### 1.2.6 并行处理技术的发展

并行性：计算机系统在同一时刻或者同一时间间隔内进行多种运算或操作。只要时间上相互重叠，就存在并行性。

- 同时性：两个及以上的事件在同一时刻发生
- 并发性：两个及以上的事件在同一时间间隔内发生

从执行程序的角度来看，并行性等级从低到高可分为：

- 指令内部并行： 单条指令中各微操作之间的并行。
- 指令级并行：并行执行两条或两条以上的指令。
- 线程级并行：并行执行两个或两个以上的线程。通常是以一个进程内派生的多个线程为调度单位。
- 任务级或过程级并行：并行执行两个或两个以上的过程或任务（程序段）， 以子程序或进程为调度单元。
- 作业或程序级并行：并行执行两个或两个以上的作业或程序。

从处理数据的角度来看， 并行性等级从低到高可分为：

- 字串位串：每次只对一个字的一位进行处理。最基本的串行处理方式，不存在并行性。
- 字串位并：同时对一个字的全部位进行处理，不同字之间是串行的。开始出现并行性。
- 字并位串：同时对许多字的同一位（称为位片）进行处理。具有较高的并行性。
- 全并行：同时对许多字的全部位或部分位进行处理。最高一级的并行。

计算机系统结构的 Flynn 分类法：按照指令和数据的关系，把计算机系统的结构分为 4 类：

- 单指令流单数据流 SISD（Single Instruction stream Single Data stream）
- 单指令流多数据流 SIMD（Single Instruction stream Multiple Data stream）
- 多指令流单数据流 MISD（Multiple Instruction stream Single Data stream）
- 多指令流多数据流 MIMD（Multiple Instruction stream Multiple Data stream）

提高并行性的途径;

1. 时间重叠
2. 资源重复
3. 资源共享

在单机系统并行性的发展中：

- 起主导作用的是时间重叠，基础是部件功能专用化
- 资源重复运用也十分普遍

![1700388531801](images/1700388531801.png)

- 资源共享的实质上是用单处理机模拟多处理机的功能

在多级系统并行性的发展中，遵循时间重叠、资源重复、资源共享原理，发展为 3 种不同的多处理机：同构型多处理机、异构型多处理机、分布式系统。

耦合度：反映多机系统中各机器之间物理连接的紧密程度和交互作用能力的强弱。

![1700388674438](images/1700388674438.png)

### 1.3 计算机系统设计和分析

#### 1.3.1 成本和价格

商品的标价由这样一些因素构成：原料成本、直接成本、毛利和折扣。

性能/成本设计：设计者需取得性能与成本之间的平衡。

对计算机系统成本产生影响的主要因素有：时间、产量、商品化等。最直接的影响是时间。

#### 1.3.2 基准测试程序

五类测试程序：

1. 真实程序
2. 修正的（或者脚本化）应用程序
3. 核心测试程序
4. 小测试程序
5. 合成测试程序

测试程序包

#### 1.3.1 量化设计基本原则

大概率事件优先原则：对于大概率事件(最常见的事件)，赋予它优先的处理权和资源使用权，以获得全局的最优结果

Amdahl 定律：

$$
\text{系统加速比}=\frac{\text{总执行时间}_\text{加速前}}{\text{总执行时间}_\text{加速后}}=\frac{1}{(1-\text{可改进比例})+\frac{\text{可改进比例}}{部件加速比}}
$$

![1700389397512](images/1700389397512.png)

程序的局部性原理：程序总是趋向于使用最近使用过的数据和指令。

CPU 的性能公式：

$$
T_{CPU}=CPI\times IC\times T_{CLK}
$$

进一步细化：一共有$n$条指令，第$i$条指令处理时间为$CPI_i$，出现次数为$IC_i$

$$
T_{CPU}=\sum_i{IC_i\times CPI_i\times T_{CLK}}\\CPI=\sum_i{\frac{IC_i}{IC}\times CPI_i}
$$

## 第二章 指令系统

### 2.1 指令系统概述

指令系统是计算机系统中软件与硬件交界的一个主要标志：

- 软件设计人员利用指令系统编制各种应用软件和系统软件
- 硬件设计人员采用各种手段实现指令系统

### 2.2 指令集结构的分类

一般来说，可以从如下五个因素考虑对计算机指令集结构进行分类，即：

- **在 CPU 中操作数的存储方法**
  - 堆栈
  - 累加器
  - 寄存器
- 指令中显式表示的操作数个数
- 操作数的寻址方式
- 指令集所提供的操作类型
- 操作数的类型和大小

指令中的操作数可以被明确地显式给出，也可以按照某种约定隐式地给出。

Z=X+Y 在这三种指令集结构上的实现方法

![1700466505043](images/1700466505043.png)

通用寄存器型指令集结构的优点：

- 在表达式求值方面，比其它类型指令集结构都具有更大的灵活性
- 寄存器可以用来存放变量
  - 寄存器比存储器快，减少了存储器的通信量，加快程序执行速度
  - 可以用更少的地址位来寻址寄存器，有效改进程序代码大小。

通用寄存器型指令集结构可以进一步细分：

- 寄存器-寄存器型 R-R
- 寄存器-存储器型 R-M
- 存储器-存储器型 M-M

![1700466730205](images/1700466730205.png)

三类指令集的优缺点：

![1700466815358](images/1700466815358.png)

### 2.3 寻址方式

![1700466885441](images/1700466885441.png)

两种表示寻址方式的方法：

- 将寻址方式编码与操作码中，由操作码描述相应操作的寻址方式。
  - 适合：采用 load-store 结构的处理机，寻址方式只有很少几种。MIPS 指令集
- 在指令字中设置专门的寻址字段，直接指出寻址方式。
  - 灵活，操作码短，但需要设置专门的寻址方式字段，而且操作码和寻址方式字段合起来所需要的总位数可能会比隐含方法的总位数多。
  - 适合：有多种寻址方式的处理机，且指令有多个操作数。VAX11

数据在内存中存放要对齐：信息在主存中存放的起始地址必须是该信息宽度（字节数）的整数倍。

![1700467157145](images/1700467157145.png)

**存在空间浪费，但保证访问速度。**

### 2.4 操作数类型和大小

![1700467309303](images/1700467309303.png)

![1700467322204](images/1700467322204.png)

![1700467335270](images/1700467335270.png)

![1700467344542](images/1700467344542.png)

![1700467358347](images/1700467358347.png)

操作数大小主要有：字节、半字 16、单字 32、双字 64。

### 2.5 指令系统的设计和优化

#### 2.5.1 指令系统设计的基本原则

指令系统的设计：

- 指令的功能设计
- 指令的格式设计

确定哪些功能由硬件实现，主要考虑三个因素：速度，成本，灵活性。

- 硬件实现：快、高、差
- 软件实现：慢、低、好

对指令系统的基本要求：

- 完整性：在一个有限可用的存储空间内，对于任何可解的问题，编制计算程序时，指令系统所提供的指令足够使用。
- 规整性：主要包括对称性和均匀性。

  - 对称性：所有与指令系统有关的存储单元的使用、操作码的设置等都是对称的。
  - 均匀性：指对于各种不同的操作数类型、字长、操作种类和数据存储单元，指令的设置都要同等对待。
- 正交性：在指令中各个不同含义的字段，如操作类型、数据类型、寻址方式字段等，在编码时应互不相关、相互独立。
- 高效率：指令的执行速度快、使用频度高。
- 兼容性：主要是要实现向后兼容，指令系统可以增加新指令，但不能删除指令或更改指令的功能。

#### 2.5.2 控制指令

控制指令是用来改变控制流的，有四种：

- 分支：有条件跳转（大部分）
- 跳转：无条件跳转
- 过程调用
- 过程返回

条件分支指令的表示：

![1700467892008](images/1700467892008.png)

过程调用和返回的状态保存策略：

- 调用者保存
- 被调用者保存

![1700467962107](images/1700467962107.png)

#### 2.5.3 指令操作码的优化

如何用最短的位数表示指令的操作信息和地址信息

等长拓展码：

![1700468120279](images/1700468120279.png)

定长拓展码：操作码长度固定。

### 2.6 指令系统的发展和改进

#### 2.6.1 沿 CISC 方向改进

CISC（复杂指令计算机）

- 面向目标程序增强指令功能：对于使用频度高的指令，用硬件加快其执行；对于使用频度高的指令串，用一条新的指令来替代。
  - 增强运算型指令的功能
  - 增强数据传送指令的功能
  - 增强程序控制指令的功能
- 面向高级语言的优化改进指令系统
  - 增强对高级语言和编译器的支持
  - 高级语言计算机：间接或直接执行高级语言的机器
- 面向操作系统的优化改进指令系统
  - 处理机工作状态和访问方式的切换
  - 进程的管理和切换
  - 存储管理和信息保护
  - 进程的同步与互斥，信号灯的管理

#### 2.6.2 沿 RISC 方向改进

RISC（精简指令计算机）

CISC 的缺点：

- 各指令的使用频率相差悬殊
- 指令系统的复杂性使得控制器硬件变得十分复杂
  - 占用大量芯片面积
  - 增加研发成本和时间，容易造成设计错误
- 其 CPI 值比较大，执行速度慢
- 规整性不好，不利于使用流水线技术提高性能

RISC 指令集设计原则：

![1700468863713](images/1700468863713.png)

### 2.7 MIPS 指令系统结构

寄存器：

- 32 个 32 位通用寄存器，R0 恒为 0
- 32 个 32 位单精度浮点寄存器

数据类型

- 整型数据：8、16、32 位
- 浮点数据：32 位单精度、64 位双精度，IEEE754 标准

寻址方式：

- 寄存器寻址
- 立即寻址
- 偏移寻址
  - 寄存器间接寻址
  - 直接寻址

指令格式：

- I 类指令
  ![1700469220980](images/1700469220980.png)
- R 类指令

  ![1700469266984](images/1700469266984.png)
- J 类指令

  ![1700469276789](images/1700469276789.png)

操作类型：

- Load 和 store 操作
- ALU 操作
- 分支和跳转指令
- 浮点操作

## 第三章 流水线技术

### 3.1 流水线概述

#### 3.1.1 流水线基本概念

流水线技术：将一重复的时序过程分解为若干子过程，每个子过程都可有效地在其专用功能段上与其它子过程同时执行，这种技术称为流水技术。

时空图：从时间和空间两个方面描述流水线的工作过程，横坐标表示时间，纵坐标表示各流水段。

流水线特点：

* 流水过程由多个相关的子过程组成，这些子过程称为流水线的“ 级”或“ 段”。段的数目称为流水线的“ 深度”
* 每个子过程由专用的功能段实现
* 各功能段的时间应基本相等，通常为1个时钟周期（ 1拍）
* 流水线需要经过一定的通过时间才能稳定
* 流水技术适合于大量重复的时序过程

#### 3.1.2 流水线分类

按功能分类：

* 单功能流水线
* 多功能流水线

按同一时间各段之间的连接方式分类：

* 静态流水线
* 动态流水线

按流水的级别分类：

* 部件级流水线
* 处理机级流水线
* 处理机间流水线

按数据表示分类：

* 标量流水处理机
* 向量流水处理机

按是否有反馈回路分类：

* 线性流水线
* 非线性流水线，存在流水线调度问题

### 3.2 MIPS基本流水线

#### 3.2.1 基本MIPS流水线

分为五个周期：取值、译码、执行/有效地址计算、访存/分支、写回

![1700535992678](images/1700535992678.png)

#### 3.2.2 流水线性能分析

三项性能指标：吞吐率、加速比、效率

吞吐率：单位时间内流水线所完成的任务数或输出结果的数量（计算公式：完成的指令条数/完成这些指令条数所需的时间）

* 最大吞吐率：

  * 如果各段时间相等，均为$\Delta t_0$，则$TP_{MAX}=\frac{1}{\Delta t_o}$
    * 如果各段时间不等，第$i$段时间为$\Delta t_i$，则$TP_{MAX}=\frac{1}{\max{\Delta t_i}}$
  * 最大吞吐率取决于流水线中最慢的一段所需时间，该段成为流水线性能瓶颈。消除瓶颈的方法：
    * 细分瓶颈段
    * 重复设置瓶颈段
* 实际吞吐率：m段流水，n条指令

  * 如果各段时间相等，均为$\Delta t_0$，那么完成时间$T=m\Delta t_0+(n-1)\Delta t_0$，则实际吞吐率$TP=\frac{n}{T}=\frac{TP_{MAX}}{1+\frac{m-1}{n}}$
  * 如果各段时间不等，第$i$段时间为$\Delta t_i$，那么完成时间$T=\sum_1^m{\Delta t_i}+(n-1)\max{\Delta t_i}$，即第一条指令流出时间+后续指令流出时间。实际吞吐率$TP=\frac{n}{\sum_1^m{\Delta t_i}+(n-1)\max{\Delta t_i}}$

加速比：加速比是指流水线速度与等功能的非流水线速度之比。$S=\frac{T_{\text{非流水}}}{T_{\text{流水}}}$

效率：效率指流水线的设备利用率。

* 由于流水线有通过时间和排空时间，所以效率E<1
* 效率$E=\frac{S}{m}$
* 也可以通过时空图占用面积与总面积之比得出

有关流水线性能的若干问题：

* 流水线并不能减少（而且一般是增加）单条指令的执行时间，但能够提高吞吐率
* 增加流水线的深度可以提高流水线性能
* 流水线深度受限于流水线的延迟和额外开销
* 需要用高速锁存器作为流水线寄存器- Earle锁存器
* 指令之间存在的相关，产生了流水线的冲突，进而限制了流水线的性能

### 3.3 流水线中的冲突

流水线冲突：相邻或相近的两条指令因存在某种关联，后一条指令不能在原先指定的时钟周期开始执行。

消除冲突基本方法：暂停

#### 3.3.1 结构冲突

原因：

* 功能部件不是全流水
* 重复设置资源不足

避免方法：

* 所有功能部件全部流水化
* 设置足够多硬件资源，代价很大

#### 3.3.2 数据冲突

原因：当指令在流水线中重叠执行时，流水线有可能改变指令读/写操作数的顺序，使之不同于它们在非流水实现时的顺序，这将导致数据冲突。

消除方法：插入暂停周期，通过定向技术减少暂停

数据冲突分类：

* 写后读冲突(RAW)：最常见
* 写后写冲突(WAW)：MIPS不会出现
* 读后写冲突(WAR)：MIPS不会出现
* 读后读冲突(RAR)：不引起冲突

需要暂停的数据冲突：load指令后紧跟一条使用寄存器的指令时，需要暂停一个周期才能使用定向解决冲突

通过编译器调度消除冲突：

![1700538816651](images/1700538816651.png)

#### 3.3.3 控制冲突

分支指令转移成功在访存段才能得到正确的跳转地址，简单暂停后续指令的指令会导致流水线暂停3个周期

减少分支开销的途径：

* 尽早判断是否分支成功
* 分支成功时尽早计算得出转移目标地址

优化时两种方法都要采用

对于MIPS流水线的改进：

* 分支测试提前到ID段
* 分支地址计算也提前到ID段
* 开销降低到1拍

减少流水线分支损失的方法：

* 冻结或排空流水线：简单的暂停后续指令的执行
* 预测分支失败：流水线照常流动，如果分支成功则要清空流水线，重新取值执行
* 预测分支成功：始终预测分支成功，直接从目标处取值执行
* 延迟分支：分支开销为n的分支指令后紧跟有n个延迟槽，遇到分支指令时正常处理并执行延迟槽中指令，减少分支开销。
  * 从前调度
  * 从目标处调度
  * 从失败处调度

![1700540343088](images/1700540343088.png)

取消分支：分支指令中包含预测方向，若预测正确，正常执行延迟槽中的指令，否则将其转换为空操作

分支处理方法的性能：

* 假设理想$CPI=1$，则加速比$S=\frac{D}{1+C}=\frac{D}{1+f\times p_{\text{分支}}}$，$D$为流水线深度，$p_{\text{分支}}$为分支开销，$C$为分支引起的流水线暂停时钟周期数（平均值），$f$为分支指令出现的频率

  ![1700540577567](images/1700540577567.png)

### 3.4 MIPS流水线分析（略）

### 3.5 向量处理机

处理d=a*(b+c)，a、b、c、d均为水平向量

* 水平处理方式，一位一位计算
* 垂直处理方式，k=b+c,d=a*k
* 分组处理方式，将长度为N的向量分为m组，每组n个元素，组内纵向处理，依次处理各组

向量机速度评价方法：

* 标量机通常用每秒执行多少指令衡量
* 每秒取得多少浮点运算结果衡量向量机速度

CRAY-1实例分析（略）

## 第四章 指令级并行
