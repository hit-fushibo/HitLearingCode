# x86系统架构概览

## 系统级体系结构概览

![img](.\images\1.png "系统级寄存器与数据结构")

如上图所示，系统级体系结构由一组寄存器、数据结构和指令组成，旨在支持基本的系统级操作，如内存管理、中断和异常处理、任务管理以及对多个处理器的控制。

下面将对

* Global and Local Descriptor Tables
* System Segments, Segment Descriptors, and Gates
* Task-State Segments and Task Gates
* Interrupt and Exception Handling
* Memory Management
* System Registers

进行介绍。

### Global and Local Descriptor Tables（全局和局部描述符表）

在保护模式下操作时，所有内存访问都通过全局描述符表（GDT）或可选的本地描述符表，如图2-1所示。这些表包含称为段描述符的条目。段描述符提供段的基本地址以及访问权限、类型和使用信息。

每个段描述符都有一个关联的段选择器。段选择器为使用它的软件提供了 GDT 或 LDT 的索引（其关联段描述符的偏移量）、全局/局部标志（确定选择器是指向 GDT 还是 LDT）以及访问权限信息。

要访问段中的字节，必须提供段选择器和偏移量。段选择器提供对段（在 GDT 或 LDT 中）的段描述符的访问。从段描述符中，处理器获得线性地址空间中段的基地址。然后，偏移量提供字节相对于基地址的位置。该机制可用于访问任何有效的代码、数据或堆栈段，前提是可以从处理器运行的当前特权级别 (CPL) 访问该段。 CPL被定义为当前执行代码段的保护级别。

为了简单起见，许多段选择器都显示为指向段的直接指针。然而，从段选择器到其关联段的实际路径始终是通过 GDT 或 LDT。

GDT基址的线性地址包含在GDT寄存器（GDTR）中； LDT 的线性地址包含在 LDT 寄存器（LDTR）中。

### System Segments, Segment Descriptors, and Gates（系统段、段描述符和门）

除了构成程序或过程的执行环境的代码、数据和堆栈段之外，该体系结构还定义了两个系统段：任务状态段（TSS）和LDT。 GDT 不被视为段，因为它不是通过段选择器和段描述符来访问的。 TSS 和 LDT 具有为其定义的段描述符。

该架构还定义了一组称为门的特殊描述符（调用门、中断门、陷阱门和任务门）。它们为系统过程和处理程序提供了受保护的网关，这些系统过程和处理程序可以在与应用程序和大多数过程不同的特权级别上运行。例如，对调用门的 CALL 可以提供对代码段中的过程的访问，该代码段的特权级别与当前代码段相同或在数值上较低（更高特权）。为了通过调用门访问过程，调用过程1为调用门提供选择器。然后，处理器对调用门执行访问权限检查，将 CPL 与调用门的特权级别以及调用门指向的目标代码段进行比较。

如果允许访问目标代码段，处理器将获取目标代码段的段选择器以及从调用门到该代码段的偏移量。如果调用需要更改特权级别，处理器也会切换到目标特权级别的堆栈。新堆栈的段选择器是从当前正在运行的任务的 TSS 中获取的。门还有助于 16 位和 32 位代码段之间的转换，反之亦然。

### Task-State Segments and Task Gates（任务状态段和任务门）

TSS定义了任务执行环境的状态。它包括通用寄存器、段寄存器、EFLAGS 寄存器、EIP 寄存器以及带有用于三个堆栈段（每个特权级别一个堆栈）的堆栈指针的段选择器的状态。 TSS 还包括与任务关联的 LDT 的段选择器以及分页结构层次结构的基地址。

保护模式下的所有程序执行都发生在任务（称为当前任务）的上下文中。当前任务的 TSS 段选择器存储在任务寄存器中。切换到任务最简单的方法是调用或跳转到新任务。这里，新任务的 TSS 的段选择器在 CALL 或 JMP 指令中给出。在切换任务时，处理器执行以下操作：

1. 将当前任务的状态存储在当前 TSS 中。
2. 将新任务的段选择器加载到任务寄存器中。
3. 通过GDT中的段描述符访问新的TSS。
4. 将新任务的状态从新 TSS 加载到通用寄存器、段寄存器、LDTR、控制寄存器 CR3（分页结构层次结构的基地址）、EFLAGS 寄存器和 EIP 寄存器中。
5. 开始执行新任务。

还可以通过任务门访问任务。任务门类似于调用门，不同之处在于它提供对 TSS 而不是代码段的访问（通过段选择器）。

### Interrupt and Exception Handling（中断和异常处理）

外部中断、软件中断和异常都是通过中断描述符表（IDT）来处理的。

IDT 存储门描述符的集合，提供对中断和异常处理程序的访问。与 GDT 一样，IDT 也不是段。 IDT 基址的线性地址包含在 IDT 寄存器 (IDTR) 中。

IDT 中的门描述符可以是中断、陷阱或任务门描述符。为了访问中断或异常处理程序，处理器首先通过 INT n、INTO、INT3、INT1 或 BOUND 指令从内部硬件、外部中断控制器或软件接收中断向量。中断向量提供了 IDT 的索引。如果所选择的门描述符是中断门或陷阱门，则以与通过调用门调用过程类似的方式访问关联的处理程序过程。如果描述符是任务门，则通过任务切换来访问处理程序。

### Memory Management（内存管理）

系统架构支持内存的直接物理寻址或虚拟内存（通过分页）。

当使用物理寻址时，线性地址被视为物理地址。使用分页时：所有代码、数据、堆栈和系统段（包括 GDT 和 IDT）都可以进行分页，并且仅将最近访问的页面保存在物理内存中。

物理内存中页（有时称为页框）的位置包含在分页结构中。

这些结构驻留在物理内存中（参见图 2-1 的 32 位分页情况）。

分页结构层次结构的基本物理地址包含在控制寄存器 CR3 中。分页结构中的条目确定页框基址的物理地址、访问权限和内存管理信息。

为了使用这种分页机制，线性地址被分成几部分。这些部分提供了分页结构和页框的单独偏移。系统可以具有单个或多个分页结构层次结构。例如，每个任务可以有自己的层次结构。

### System Registers（系统寄存器）

为了帮助初始化处理器和控制系统操作，系统架构在 EFLAGS 寄存器和几个系统寄存器中提供了系统标志：

* EFLAGS 寄存器中的系统标志和 IOPL 字段控制任务和模式切换、中断处理、指令跟踪和访问权限。
* 控制寄存器（CR0、CR2、CR3 和 CR4）包含用于控制系统级操作的各种标志和数据字段。这些寄存器中的其他标志用于指示操作系统或执行程序内对特定处理器功能的支持。
* 调试寄存器（图中未显示）允许设置断点以用于调试程序和系统软件。
* GDTR、LDTR 和 IDTR 寄存器包含其各自表的线性地址和大小。
* 任务寄存器包含当前任务的 TSS 的线性地址和大小。
* 模型特定寄存器（图中未显示）。模型特定寄存器 (MSR) 是一组主要可供操作系统或执行程序（即在特权级别 0 运行的代码）使用的寄存器。这些寄存器控制调试扩展、性能监控计数器、机器检查架构和内存类型范围 (MTRR) 等项目。

## 实模式和保护模式转换

x86架构支持实模式（Real-address mode）和保护模式（Protected mode）两种操作模式。

* 保护模式：处理器的本机操作模式。它提供了一组丰富的架构特性、灵活性、高性能以及对现有软件库的向后兼容性。
* 实模式：提供了 Intel 8086 处理器的编程环境，并具有一些扩展功能（例如切换到保护模式或系统管理模式的能力）。

更一般地，实模式是早期的模式，提供了对物理内存的直接访问，但没有内存保护和多任务支持。保护模式是一种更先进的模式，提供了内存保护、虚拟内存、多任务等功能。

要从实模式切换为保护模式，需要进行以下更改：

1. 设置GDT和IDT：首先，需要定义和加载全局描述符表（GDT）和中断描述符表（IDT），以便在保护模式下正确处理段和中断。
2. 修改控制寄存器（CR0）：需要将控制寄存器（CR0）的一些位设置为保护模式所需的值。具体来说，需要将CR0的第0位（PE位）设置为1，表示启用保护模式。
3. 加载段选择子：在进入保护模式后，需要修改段选择子，以加载保护模式下的正确段描述符。段选择子是一个16位的值，包含了段的索引和特权级别等信息。
4. 设置页表：保护模式下的内存管理是通过分页机制实现的。因此，需要定义和加载页表，以实现虚拟内存管理。页表是一种数据结构，用于将虚拟地址映射到物理地址。
5. 切换堆栈：在保护模式下，堆栈的使用方式可能与实模式下不同。因此，需要切换堆栈，以便在保护模式下正确处理函数调用和中断。

而要从保护模式切换为实模式，需要进行以下更改：

1. 清除分页机制：在保护模式下，使用了分页机制来管理内存。因此，需要禁用分页机制，将控制寄存器（CR0）的第31位（PG位）设置为0，以禁用分页。
2. 清除段选择子：在保护模式下，使用了段描述符来访问内存。为了切换回实模式，需要将段选择子设置为实模式下的默认值。实模式下的段选择子只包含段的偏移地址，没有特权级别等其他信息。
3. 清除GDT和IDT：在保护模式下，使用了全局描述符表（GDT）和中断描述符表（IDT）来管理段和中断。为了切换回实模式，需要将GDT和IDT设置为实模式下的默认值，或者完全禁用它们。
4. 清除页表：在保护模式下，使用了页表来管理虚拟内存。为了切换回实模式，需要禁用页表，或者将页表设置为实模式下的默认值。
5. 切换堆栈：在保护模式下，堆栈的使用方式可能与实模式下不同。为了切换回实模式，需要切换回实模式下的堆栈，以便在实模式下正确处理函数调用和中断。

## 80x86系统指令寄存器

为了协助处理器执行初始化和控制系统操作，80X86提供了一个标志寄存器EFLAGS和几个系统寄存器。除了一些通用状态标志外，EFLAGFS中还包含几个系统标志用于控制任务切换、中断处理、指令跟踪以及访问权限。系统寄存器用于内存管理和控制处理器操作，含有分段和分页处理机制系统表的基地址、控制处理器操作的比特标志位。

### 标志寄存器EFLAGS

### 内存管理寄存器

### 控制寄存器

## 系统指令

系统指令用于处理系统级功能。大多数系统指令只能由处于特权级0的操作系统软件执行，其余一些指令可以在任何特权级上执行。下表列出一些常见的系统指令。

| 指令 | 是否受保护 | 说明                                                                        |
| :--: | :--------: | :-------------------------------------------------------------------------- |
| LGDT |     是     | 加载全局描述符表寄存器GDTR。把GDT表的基地址和长度从内存加载到GDTR中。       |
| SGDT |     否     | 保存全局描述符表寄存器 GDTR。把GDTR中IDT表的基地址和长度保存到内存中        |
| LIDT |     是     | 加载中断描述符表寄存器IDTR。把IDT表的基地址和长度从内存加载到IDTR中。       |
| SIDT |     否     | 保存中断描述符表寄存器 IDTR。把 IDTR中 IDT 表的基地址和长度保存到内存中     |
| LLDT |     是     | 加载局部描述符表寄存器LDTR。从内存加载LDT段选择符和段描述符到LDTR寄存器中。 |
| SLDT |     否     | 保存局部描述符表奇存器LDTR。把 LDTR中的LDT段选择符保存到内存或通用寄存器中  |
| LTR |     是     | 加载任务寄存器TR。把TSS段选择符（和段描述符）加载到任务寄存器中             |
| STR |     否     | 保存任务寄存器TR。把TR中当前任务TSS段选择符保存到内存或同通用寄存器中。     |
