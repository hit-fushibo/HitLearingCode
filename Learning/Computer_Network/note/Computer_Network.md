# 哈工大本部 2023 秋计算网络笔记

## 0 计算机网络概述

### 0.1 计算机网络基本概念

#### 0.1.1 计算机网络

计算机网络是**通信技术**与**计算机技术**紧密结合的产物，就是一种通信网络。

计算机网络就是**互连的、自治的**计算机集合。

- 互连：互联互通
- 自治：无主从关系

当计算机距离远、数量大时需要通过交换网络互联主机。

什么是 Internet：

- 组成细节角度：ISP 网络互连的“网络之网络”
  - 计算机设备的集合
  - 通信链路
  - 分组交换
- 服务角度：
  - 为网络应用提供通信服务的通信基础设施
  - 为网络应用提供应用编程接口

#### 0.1.2 网络协议

网络协议(network protocol)，简称为协议，是为进行网络中的数据交换而建立的规则、标准或约定。规定了通信实体之间所交换的信息的**格式、意义、顺序**以及针对收到的信息或发生的事件所采取的“**动作**”。协议规范了网络中所有信息发送和接收过程

协议三要素：

1. 语法
2. 语义
3. 时序

### 0.2 计算机网络结构

#### 网络边缘

- 主机（端系统）
  - 位于网络边缘
  - 可分为客户和服务器，客户/服务器应用模型(CS)：客户发送请求，接受服务器响应
  - 对等应用模型(P2P)：无（不仅依赖）专用服务器，通信在对等实体之间直接进行
- 网络应用

#### 接入网络

将端系统物理连接到其边缘路由器的网络

##### 数字用户线路（DSL）

利用已有的电话线连接中心局的 DSLAM

- 数据通信通过 DSL 电话线接入 Internet
- 电话通过 DSL 电话线接入电话网
- <2.5Mbps 上行传输速率
- <24Mbps 下行传输速率

使用频分多路复用技术，在不同频带上传输不同频道

- 50kHz~1MHz 用于下行
- 4kHz~50kHz 用于上行
- 0kHz~4kHz 用于传统电话

##### 电缆网络

利用混合光纤同轴电缆（HFC）进行连接

- 30Mbps 下行传输速率
- 2Mbps 上行传输速率

各家庭通过电缆网络->光纤接入 ISP 路由器

- 各家庭共享家庭到电缆头端的接入网络
- DSL 独占至中心局的接入网络

典型的家庭接入网络![1693970052668](images/1693970052668.png)

##### 以太网

- 机构企业常用
- 典型传输速率： 10 Mbps, 100Mbps, 1Gbps, 10Gbps
- 目前，端系统通常直接连接以太网交换机（switch）

##### 无线接入网络

通过共享的无线接入网络连接端系统和路由器

- 无线局域网（LANs）：
  - 同一建筑物内
  - 11Mbps、54Mbps 传输速率
- 广域无线接入网络：
  - 通过运营商的蜂窝网络，接入范围在几十公里
  - 1Mbps、10Mbps、100Mbps 传输速率

### 0.3 网络核心

互联的路由器网络，关键功能是：路由和转发

- 路由：确定分组从源到目的地的传输路径
- 转发：将分组从路由器的输入端口交换至正确的输出端口

#### 数据交换

数据交换的类型

- 电路交换

  - 最典型的电路交换网络：电话网络
  - 三个阶段
    - 建立连接
    - 通信
    - 释放连接
  - 独占线路资源
  - 如何共享中继线-多路复用：将链路/网络资源划分为资源片
    - 将资源片分配给各路呼叫
    - 每路呼叫独占分配到的资源片进行通信
    - 资源片可能闲置
  - 典型多路复用方法
    - 频分多路复用-FDM（调制到不同频率）
      - 各用户占用不同的带宽资源（频率带宽）
    - 时分多路复用-TDM（调制到不同时间）
      - 将时间划分为等长的时分复用帧，每个用户在每个时分复用帧中占用固定序号的时隙
      - 在不同时间占用相同的频带宽度
    - 波分多路复用-WDM（调制到不同波长）
      - 光的频分复用
    - 码分多路复用-CDM（调制到不同编码）
      - 详见物理层
- 报文交换

  - 报文：源发送的信息整体
- 分组交换

  - 分组：将报文拆分成一系列相对较小的数据包
  - 分组交换需要进行报文的拆分与重组，产生额外开销

报文交换和分组交换

- 报文交换和分组交换都采用**存储-转发**机制

  - 报文交换以报文为基本单位
  - 分组交换以分组为基本单位
- 假设

  - 报文大小为 M bits
  - 链路带宽为 R bps
  - 分组长度为 L bits
  - 跳步数 h
  - 路由器数 n
- 报文交换的交付时间

  - hM/R
- 分组交换的交付时间（参考流水线的完成时间：流出时间+流水段数\*流水段时延）

  - M/R+nL/R

分组交换和电路交换

- 分组交换允许更多的用户同时使用网络
- 分组交换适用于**突发**数据传输网络，可能产生拥塞

分组交换的优点

- 高效：动态分配传输带宽，对通信链路是逐段占用
- 灵活：以分组为传输单位和查找路由
- 迅速：不必先建立连接就能向其他主机发送分组
- 可靠：保证可靠性的网络协议；分布式的路由选择协议使网络有很好的生存性

分组交换的问题

- 分组在各节点存储转发需要排队，会造成一定的时延
- 分组必须携带首部也造成了一定的开销

### 0.4 计算机网络性能

速率

- 单位时间传输信息量
- 最重要的一个性能指标
- 往往指的是额定速率或标称速率

带宽

- 数字信道所能传送的最高数据率

分组时延

- 产生原因

  - 分组到达速率超出链路容量
  - 分组排队
- 分类

  - $d_{proc}$结点处理延迟

    - 差错检测
    - 确定输出链路
  - $d_{queue}$排队延迟

    - 等待输出链路可用
    - 取决于路由器拥塞程度
    - R：链路带宽
    - L：分组长度
    - a：平均分组到达速率
    - 流量强度=La/R
    - 流量强度与平均排队时延的关系

      ![1701002930539](images/1701002930539.png)
  - $d_{trans}$传输延迟

    - $L$:分组长度
    - $R$:链路带宽
    - $d_{trans}=L/R$
  - $d_{prop}$传播延迟

    - $d$：物理链路长度
    - $s$：信号传播速度
    - $d_{prop}=d/s$
  - $d_{nodal}=d_{proc}+d_{queue}+d_{trans}+d_{prop}$

时延带宽积

- 时延带宽积=传播时延\*带宽
- 以比特为单位的链路长度

分组丢失

- 队列缓存容量有限
- 分组到达已满队列将被丢弃
- 丢弃分组由前序结点或源重发（也有可能不重发）
- 丢包率=丢包数/已发送分组数

吞吐量

- 表示在发送端与接收端之间传输数据速率
  - 即时吞吐率：给定时间的速率
  - 平均吞吐率：一段时间的平均速率
- 瓶颈链路
  - 端到端路径上，限制端到端吞吐率的链路

### 0.5 计算机网络体系结构

- 网络体系结构是从功能上描述计算机网络结构
- 网络体系结构使分层结构
- 每层遵循某个/些网络协议完成本层功能
- 加算计网络体系结构是计算机网络的各层及其协议的集合
- 体系结构是一个计算机网络的功能层次及其关系的定义
- 体系结构是抽象的

分层网络结构的基本概念

- 实体(entity) 表示任何可发送或接收信息的硬件或软件进程。
- 协议是控制两个对等实体进行通信的规则的集合，协议是“水平的” 。
- 任一层实体需要使用下层服务，遵循本层协议，实现本层功能， 向上层提供服务，服务是“垂直的” 。
- 下层协议的实现对上层的服务用户是透明的。
- 同系统的相邻层实体间通过接口进行交互，通过服务访问点 SAP(Service Access Point)，交换原语，指定请求的特定服务。

OSI 参考模型

![1701003865369](images/1701003865369.png)

端-端层：7-4 层

各个层次的功能

- 物理层
  - 接口特性
    - 机械特性、电器特性、功能特性、规程特性
  - 比特编码
  - 数据率
  - 比特同步
    - 时钟同步
  - 传输模式
    - 单工
    - 半双工
    - 全双工
- 数据链路层
  - 负责结点-结点数据传输
  - 组帧
  - 物理寻址
  - 流量控制
  - 差错控制：检测差错并重传、避免重复帧
  - 访问控制：决定物理介质的使用权
- 网络层
  - 负责源主机到目的主机数据分组交付
  - 逻辑寻址
  - 路由
  - 分组转发
- 传输层
  - 负责端到端（进程间）报文传输
  - 分段与重组
  - SAP 寻址
  - 连接控制
  - 流量控制
  - 差错控制
- 会话层
  - 对话控制
  - 同步
- 表示层
  - 数据表示转化
  - 加密/解密
  - 压缩/解压缩
- 应用层
  - 支持用户通过用户代理（浏览器）或网络接口使用网络

TCP/IP 参考模型

![1701004519934](images/1701004519934.png)

![1701005137427](images/1701005137427.png)

路由器在转发分组时最高只用到网际层而没有使用传输层和应用层

5 层参考模型

![1701004549787](images/1701004549787.png)

- 应用层：支持各种网络应用
- 传输层：进程到进程的数据传输
  - TCP/IP 的可靠性传输是在这层实现的
- 网络层：源主机到目的主机的数据分组路由转发
  - 实现跨越网络通信时的路径选择和数据传输
  - 硬件上依靠路由器实现路径选择和异构网络的协议转换
  - 软件上 IP 协议实现了同一的 IP 编址
- 链路层：相邻网络元素（主机、交换机、路由器，也称结点）的数据传输
- 物理层：比特传输
  - 面向通信
  - 无线传输
  - 数字调制以及多路复用

5 层参考模型的数据封装

![1701004862572](images/1701004862572.png)

链路层不仅加首部也加尾部

协议是水平的，服务是垂直的

- 对等层通信
  - 两个同样的层次把 PDU（数据单元加控制信息）通过水平虚线直接传递给对方
- 协议的水平
  - 各层协议实际上就是在各个对等层之间传递数据时的各项规定
- 服务的垂直
  - 在协议的控制下，两个对等实体之间的通信使得本层能够向**上一层**提供服务

封装

- 应用数据沿协议栈向下流动
- 在每层都会附加相应的首部
- 首部中最重要的信息之一是地址
  - 除此之外还有各种控制信息
  - 每层协议使用的地址不同
- 首部只能由对等层实体拆除

网络中的几类地址

- 物理地址
  - 网络接口层（链路层和物理层）使用，主要指以太网使用的 MAC 地址
- 逻辑地址
  - 网络层使用，IP 地址
- 端口地址
  - 传输层使用
  - 定位主机上的进程
- 域名地址
  - 应用层使用
  - 层次化，符号化地址
  - 解决 IP 地址难记和难使用的问题，无法直接用于计算机通信
  - 使用时需要域名映射到 IP 地址（DNS）
- 关系
  ![1701005501844](images/1701005501844.png)

网络中通信双方的进程标识

- IP 地址+端口号
- 网络中双方的通信可以用（本地 IP、本地端口、远程 IP、远程端口）

## 1 网络层

### 1.1 网络应用体系结构

* 客户机/服务器结构（C/S）
  * 服务器
    * 7*24小时提供服务
    * 永久性访问地址/域名
    * 利用大量服务器实现可拓展性
  * 客户机
    * 与服务器通信，使用服务器提供的服务
    * 间歇性接入网络
    * 可能使用动态IP地址
    * 不会与其他客户机直接通信
  * 集中管理方便、客户机之间不直接通信、可拓展性不佳
* P2P结构
  * 没有永远在线的服务器
  * 任意端系统/节点之间可以直接通信
  * 节点间歇性接入网络
  * 节点可能改变IP地址
  * 优点：高度可伸缩
  * 缺点：难以管理
* 混合结构
  * 文件传输用P2P结构
  * 文件搜索用C/S结构
    * 每个节点向中央服务器登记自己的内容
    * 每个节点向中央服务器提交查询请求

### 1.2 网络应用进程通信

进程

* 主机上运行的程序
* 客户机进程：发起通信的进程
* 服务器进程：等待通信的进程
* 进程通信
  * 同一主机：进程间通信机制，操作系统提供
  * 不同主机：消息交换
* 用IP地址+端口号标识，进程寻址

套接字：同一主机内应用层与传输层之间的接口，可以向网络发送报文、接收报文

* 传输协议的选择
* 参数设置

应用层协议

* 网络应用需要遵循的应用层协议
* 公开协议
  * 由RFC定义
  * 允许互操作
* 私有协议
  * P2P文件共享应用
* 协议内容
  * 消息的类型
    * 请求消息
    * 响应消息
  * 消息的语法
    * 字段及其描述
* 字段的语义
* 规则
  * 何时发送/相应消息
  * 如何发送/相应消息

网络应用对传输服务的需求

* 可靠的数据传输
* 安全性
* 时间
* 吞吐量/带宽

Internet提供的传输服务

* TCP
  * 面向连接
  * 可靠数据传输
  * 流量控制
  * 拥塞控制
  * 不提供时间保障
  * 不提供最小带宽保障
* UDP
  * 无连接
  * 不可靠
  * 只提供差错检查和复用/分用

### 1.3 Web应用

#### 1.3.1 web构成

网页、网页相互链接

网页包含多个对象

* 对象：HTML文件、图片、视频文件、动态脚本等
* 基本HTML文件：包含对其他对象引用的链接

对象的寻址

* URL：统一资源定位器
  * 格式
    Scheme://host:port/path

Web应用遵循HTTP协议（超文本传输协议）

#### 1.3.2 HTTP协议

采用C/S结构

* 客户-Browser：请求、接受、展示Web对象
* 服务器-Web Server：相应客户请求、发送对象

版本

* 1.0
* 1.1

使用TCP传输服务

* 服务器在80端口等待客户请求
* 浏览器发起到服务器的TCP链接（创建套接字）
* 服务器接受来自浏览器的TCP链接
* 浏览器与服务器交换HTTP消息
* 关闭TCP链接

无状态服务

* 服务器不维护任何有关客户端过去所发请求的信息

连接类型

* 非持久性连接 1.0版本
  * 每个TCP连接最多传输一个对象
  * 每个对象需要两个RTT
  * 响应时间
    * 发起、建立TCP连接：一个RTT
    * 发送HTTP请求消息到响应消息的前几个字节到达：一个RTT
    * 文件传输时间
    * total=2RTT+文件发送时间
* 持久性连接：每个TCP连接允许传输多个对象 1.1版本
  * 不带流水线
    * 每个对象耗时1个RTT
  * 带流水线（缺省模式）
    * 理想情况下，收到所有对象只需耗时约一个RTT

HTTP消息格式

* 请求报文
  * 请求行：方法、URL、版本\n\r
  * 请求头：每行都是头部域名称、头部域值\n\r
  * 请求体：请求数据。与请求头之间用\n\r隔开，请求行和请求头之间不用
* 响应报文
  * 相应行：版本、状态码、原因短语
  * 请求头：与请求报文相同
  * 响应数据

请求方法

* POST
* GET
* HEAD，没有响应数据的GET
* PUT，上传文件，1.1版本才有
* DELETE，删除文件，1.1版本才有

响应状态码

* 200 OK，正常
* 301 Moved Permanently，重定向
* 400 Bad Request，请求中缺少必须信息
* 404 Not Found，请求资源不存在
* 505 HTTP Version Not Supported

Cookie技术

* HTTP无状态，但是很多应用要求服务器掌握客户端状态
* 作用
  * 身份认证
  * 购物车
  * 推荐
* 风险
  * 信息泄露
* 组件
  * HTTP响应消息的cookie头部行
  * HTTP请求消息的cookie头部行
  * 保存在客户端主机上的cookie文件，由浏览器管理
  * Web服务器后台数据库

Web缓存/代理服务器技术

* 功能

  在不访问服务器的前提下满足客户端的HTTP请求
* 好处

  * 缩短客户请求时间
  * 减少组织流量
  * 在大范围内实现有效的内容分发
* 运行流程

  * 用户设定浏览器通过代理服务器进行Web访问
  * 代理服务器接收到用户请求
    * 如果请求对象在缓存中，直接返回缓存对象
    * 否则，向原始服务器发送HTTP请求，获取对象并返回给客户端同时缓存下来
* 代理服务器级充当客户端，也充当服务端，一般由ISP架设
* 缓存的更新

  * 如果缓存是最新版本，则直接返回
  * 在HTTP请求消息中加入If-modified-since:\<date\>
  * 根据返回的状态码判断是否是最新版本：304 Not Modified

### 1.4 Email应用

Email应用的构成

* 邮件客户端（用户代理）
  * 进行邮件撰写和编辑
* 邮件服务器
  * 发送、接收邮件、维护用户邮箱
* 电子邮件所需协议
  * SMTP、POP3

电子邮件传输协议

* SMTP协议
  * 发送电子邮件，不涉及邮件管理
  * 一般不使用中间邮件服务器进行连接
  * 使用TCP进行email消息的可靠传输
  * 使用端口25
  * 传输过程的三个阶段

    * 握手
    * 消息传输
    * 关闭
  * 命令/响应交互模式

    * 命令：ASCII文本
    * 响应：状态代码和语句
  * Email消息只能包含7位ASCII码
  * 与HTTP对比

    ![1701010821485](images/1701010821485.png)
  * Email消息格式

    * 头部行
      * To
      * From
      * Subject
    * 消息体
      * 消息本身
      * 只能是ASCII字符
    * 针对多媒体的拓展，MIME
      * 通过在邮件头部增加额外的行声明MIME的内容类型

电子邮件访问协议

* POP
  * 认证过程
    * 客户端命令
      * User：用户名
      * Pass：密码
    * 服务器响应
      * +OK
      * -ERR
  * 事务阶段
    * List：列出消息数量
    * Retr：用编号获取消息
    * Dele：删除消息
    * Quit
  * 下载并删除：如果用户换了客户端软件，无法重读邮件
  * 下载并保持：不同客户端都可以保留消息的拷贝
  * POP3是无状态的
  * 端口号：110
* IMAP
  * 所有消息统一保存在服务器
  * 允许客户利用文件夹组织消息
  * 支持跨会话的用户状态
    * 文件夹的名字
    * 文件夹与消息ID之间的映射
* HTTP

### 1.5 DNS

DNS（Domain Name System）

* 功能
  * 解决Internet上主机/路由器的识别问题
  * 域名到IP地址的映射
* 性质
  * 多层命名服务器构成的分布式数据库

    * 根域名服务器
    * 顶级域名服务器：负责com, org, net,edu等顶级域名和国家顶级域名
    * 权威域名服务器：组织的域名解析服务器，提供组织内部服务器的解析服务
    * 本地域名解析服务器
      * 不严格属于层次体系
      * 每个ISP都有一个本地域名解析服务器
      * 当主机进行DNS查询时，查询被发送到本地域名服务器
  * 应用层协议：完成对域名的解析
* DNS服务
  * 域名向IP地址的转换
  * 主机别名
  * 邮件服务器别名
  * 负载均衡
* 为什么不采用集中式DNS
  * 单点失败问题
  * 流量问题
  * 距离问题
  * 维护性问题
* 分布式缺点
  * 多段访问，消耗时间和资源
* DNS查询
  * 迭代式查询

    ![1701011699046](images/1701011699046.png)
  * 递归查询

    ![1701011713659](images/1701011713659.png)
* DNS缓存-只要DNS服务器获得域名-IP映射，即缓存这一映射
  * 一段时间后缓存失效
  * 本地域名服务器一般会缓存顶级域名服务器的映射，因此根域名服务器不经常被访问
* DNS记录，资源记录RR(name,value,type,ttl)
  * type=A
    * Name：主机域名
    * Value：IP地址
  * type=B
    * Name：域（edu.cn）
    * Value：该域权威域名解析服务器的主机域名
  * type=CNAME
    * Name：某一真实域名的别名
    * Value：真实域名
  * type=MX
    * Value是别名为name的邮件服务器的规范主机名
  * ttl：该记录的生存时间
* DNS协议与消息
  * DNS报文：请求报文和响应报文相同格式

    ![1701012251612](images/1701012251612.png)

### 1.6 P2P应用
