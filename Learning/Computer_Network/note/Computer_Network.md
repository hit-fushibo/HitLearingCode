<div STYLE="page-break-after: always;"></div>

# 哈工大本部 2023 秋计算网络笔记

主要是 MOOC 上的 PPT+黑皮书+王道+课堂 PPT

笔记结构基本按照 MOOC 上的顺序来的，在每一部分补充王道和课堂 PPT 内容

预祝大家取得好成绩

---

## 0 计算机网络概述

### 0.1 计算机网络基本概念

#### 0.1.1 计算机网络

计算机网络是**通信技术**与**计算机技术**紧密结合的产物，就是一种通信网络。

计算机网络就是**互连的、自治的**计算机集合。

- 互连：互联互通
- 自治：无主从关系

当计算机距离远、数量大时需要通过交换网络互联主机。

计算机网络的组成

- 从组成部分上看
  - 硬件：主机（端系统）、通信链路、交换设备和通信处理机（如网卡）等组成
  - 软件：实现资源共享的软件和方便用户使用的软件
  - 协议
- 从工作方式上看
  - 边缘网络
  - 核心网络
- 从功能组成上看
  - 通信子网：传输介质、通信设备、相应的网络协议
  - 资源子网：实现资源共享功能的设备及其软件的集合

计算机网络功能

- 数据通信，最基本最重要
- 资源共享
- 分布式处理
- 提高可靠性
- 负载均衡

计算机网络分类

- 分布范围
  - 广域网（WAN）
  - 城域网（MAN）
  - 局域网（LAN）
  - 个人局域网（PAN）
- 传输技术
  - 广播式网络
  - 点对点网络
- 拓扑结构
  - 总线型网络
  - 星型网络
  - 环形网络
  - 网状网络
- 使用者
  - 公用网
  - 专用网
- 交换技术
  - 电路交换网络
  - 报文交换网络
  - 分组交换网络
- 传输介质
  - 有线网
  - 无线网

什么是 Internet：

- 组成细节角度：ISP 网络互连的“网络之网络”
  - 计算机设备的集合
  - 通信链路
  - 分组交换
- 服务角度：
  - 为网络应用提供通信服务的通信基础设施
  - 为网络应用提供应用编程接口

#### 0.1.2 网络协议

网络协议(network protocol)，简称为协议，是为进行网络中的数据交换而建立的规则、标准或约定。规定了通信实体之间所交换的信息的**格式、意义、顺序**以及针对收到的信息或发生的事件所采取的“**动作**”。协议规范了网络中所有信息发送和接收过程

协议三要素：

1. 语法
2. 语义
3. 时序

### 0.2 计算机网络结构

#### 网络边缘

- 主机（端系统）
  - 位于网络边缘
  - 可分为客户和服务器，客户/服务器应用模型(CS)：客户发送请求，接受服务器响应
  - 对等应用模型(P2P)：无（不仅依赖）专用服务器，通信在对等实体之间直接进行
- 网络应用

#### 接入网络

将端系统物理连接到其边缘路由器的网络

##### 数字用户线路（DSL）

利用已有的电话线连接中心局的 DSLAM

- 数据通信通过 DSL 电话线接入 Internet
- 电话通过 DSL 电话线接入电话网
- <2.5Mbps 上行传输速率
- <24Mbps 下行传输速率

使用频分多路复用技术，在不同频带上传输不同频道

- 50kHz~1MHz 用于下行
- 4kHz~50kHz 用于上行
- 0kHz~4kHz 用于传统电话

##### 电缆网络

利用混合光纤同轴电缆（HFC）进行连接

- 30Mbps 下行传输速率
- 2Mbps 上行传输速率

各家庭通过电缆网络->光纤接入 ISP 路由器

- 各家庭共享家庭到电缆头端的接入网络
- DSL 独占至中心局的接入网络

典型的家庭接入网络![1693970052668](images/1693970052668.png)

##### 以太网

- 机构企业常用
- 典型传输速率： 10 Mbps, 100Mbps, 1Gbps, 10Gbps
- 目前，端系统通常直接连接以太网交换机（switch）

##### 无线接入网络

通过共享的无线接入网络连接端系统和路由器

- 无线局域网（LANs）：
  - 同一建筑物内
  - 11Mbps、54Mbps 传输速率
- 广域无线接入网络：
  - 通过运营商的蜂窝网络，接入范围在几十公里
  - 1Mbps、10Mbps、100Mbps 传输速率

### 0.3 网络核心

互联的路由器网络，关键功能是：路由和转发

- 路由：确定分组从源到目的地的传输路径
- 转发：将分组从路由器的输入端口交换至正确的输出端口

#### 数据交换

数据交换的类型

- 电路交换

  - 最典型的电路交换网络：电话网络
  - 三个阶段
    - 建立连接
    - 通信
    - 释放连接
  - 独占线路资源
  - 如何共享中继线-多路复用：将链路/网络资源划分为资源片
    - 将资源片分配给各路呼叫
    - 每路呼叫独占分配到的资源片进行通信
    - 资源片可能闲置
  - 典型多路复用方法
    - 频分多路复用-FDM（调制到不同频率）
      - 各用户占用不同的带宽资源（频率带宽）
    - 时分多路复用-TDM（调制到不同时间）
      - 将时间划分为等长的时分复用帧，每个用户在每个时分复用帧中占用固定序号的时隙
      - 在不同时间占用相同的频带宽度
    - 波分多路复用-WDM（调制到不同波长）
      - 光的频分复用
    - 码分多路复用-CDM（调制到不同编码）
      - 详见物理层
- 报文交换

  - 报文：源发送的信息整体
- 分组交换

  - 分组：将报文拆分成一系列相对较小的数据包
  - 分组交换需要进行报文的拆分与重组，产生额外开销

报文交换和分组交换

- 报文交换和分组交换都采用**存储-转发**机制

  - 报文交换以报文为基本单位
  - 分组交换以分组为基本单位
- 假设

  - 报文大小为 M bits
  - 链路带宽为 R bps
  - 分组长度为 L bits
  - 跳步数 h
  - 路由器数 n
- 报文交换的交付时间

  - hM/R
- 分组交换的交付时间（参考流水线的完成时间：流出时间+流水段数\*流水段时延）

  - M/R+nL/R

分组交换和电路交换

- 分组交换允许更多的用户同时使用网络
- 分组交换适用于**突发**数据传输网络，可能产生拥塞

分组交换的优点

- 高效：动态分配传输带宽，对通信链路是逐段占用
- 灵活：以分组为传输单位和查找路由
- 迅速：不必先建立连接就能向其他主机发送分组
- 可靠：保证可靠性的网络协议；分布式的路由选择协议使网络有很好的生存性

分组交换的问题

- 分组在各节点存储转发需要排队，会造成一定的时延
- 分组必须携带首部也造成了一定的开销

### 0.4 计算机网络性能

速率

- 单位时间传输信息量
- 最重要的一个性能指标
- 往往指的是额定速率或标称速率

带宽

- 数字信道所能传送的最高数据率

分组时延

- 产生原因

  - 分组到达速率超出链路容量
  - 分组排队
- 分类

  - $d_{proc}$结点处理延迟

    - 差错检测
    - 确定输出链路
  - $d_{queue}$排队延迟

    - 等待输出链路可用
    - 取决于路由器拥塞程度
    - R：链路带宽
    - L：分组长度
    - a：平均分组到达速率
    - 流量强度=La/R
    - 流量强度与平均排队时延的关系

      ![1701002930539](images/1701002930539.png)
  - $d_{trans}$传输延迟

    - $L$:分组长度
    - $R$:链路带宽
    - $d_{trans}=L/R$
  - $d_{prop}$传播延迟

    - $d$：物理链路长度
    - $s$：信号传播速度
    - $d_{prop}=d/s$
  - $d_{nodal}=d_{proc}+d_{queue}+d_{trans}+d_{prop}$

时延带宽积

- 时延带宽积=传播时延\*带宽
- 以比特为单位的链路长度

分组丢失

- 队列缓存容量有限
- 分组到达已满队列将被丢弃
- 丢弃分组由前序结点或源重发（也有可能不重发）
- 丢包率=丢包数/已发送分组数

吞吐量

- 表示在发送端与接收端之间传输数据速率
  - 即时吞吐率：给定时间的速率
  - 平均吞吐率：一段时间的平均速率
- 瓶颈链路
  - 端到端路径上，限制端到端吞吐率的链路

信道利用率：有数据通过时间/总工作时间

### 0.5 计算机网络体系结构

- 网络体系结构是从功能上描述计算机网络结构
- 网络体系结构使分层结构
- 每层遵循某个/些网络协议完成本层功能
- 加算计网络体系结构是计算机网络的各层及其协议的集合
- 体系结构是一个计算机网络的功能层次及其关系的定义
- 体系结构是抽象的

分层网络结构的基本概念

- 实体(entity) 表示任何可发送或接收信息的硬件或软件进程。
- 协议是控制两个对等实体进行通信的规则的集合，协议是“水平的” 。
- 任一层实体需要使用下层服务，遵循本层协议，实现本层功能， 向上层提供服务，服务是“垂直的” 。
- 下层协议的实现对上层的服务用户是透明的。
- 同系统的相邻层实体间通过接口进行交互，通过服务访问点 SAP(Service Access Point)，交换原语，指定请求的特定服务。

OSI 参考模型

![1701003865369](images/1701003865369.png)

端-端层：7-4 层

各个层次的功能

- 物理层
  - 接口特性
    - 机械特性、电器特性、功能特性、规程特性
  - 比特编码
  - 数据率
  - 比特同步
    - 时钟同步
  - 传输模式
    - 单工
    - 半双工
    - 全双工
- 数据链路层
  - 负责结点-结点数据传输
  - 组帧
  - 物理寻址
  - 流量控制
  - 差错控制：检测差错并重传、避免重复帧
  - 访问控制：决定物理介质的使用权
- 网络层
  - 负责源主机到目的主机数据分组交付
  - 逻辑寻址
  - 路由
  - 分组转发
- 传输层
  - 负责端到端（进程间）报文传输
  - 分段与重组
  - SAP 寻址
  - 连接控制
  - 流量控制
  - 差错控制
- 会话层
  - 对话控制
  - 同步
- 表示层
  - 数据表示转化
  - 加密/解密
  - 压缩/解压缩
- 应用层
  - 支持用户通过用户代理（浏览器）或网络接口使用网络

TCP/IP 参考模型

![1701004519934](images/1701004519934.png)

![1701005137427](images/1701005137427.png)

路由器在转发分组时最高只用到网际层而没有使用传输层和应用层

5 层参考模型

![1701004549787](images/1701004549787.png)

- 应用层：支持各种网络应用
- 传输层：进程到进程的数据传输
  - TCP/IP 的可靠性传输是在这层实现的
- 网络层：源主机到目的主机的数据分组路由转发
  - 实现跨越网络通信时的路径选择和数据传输
  - 硬件上依靠路由器实现路径选择和异构网络的协议转换
  - 软件上 IP 协议实现了同一的 IP 编址
- 链路层：相邻网络元素（主机、交换机、路由器，也称结点）的数据传输
- 物理层：比特传输
  - 面向通信
  - 无线传输
  - 数字调制以及多路复用

5 层参考模型的数据封装

![1701004862572](images/1701004862572.png)

链路层不仅加首部也加尾部

协议是水平的，服务是垂直的

- 对等层通信
  - 两个同样的层次把 PDU（数据单元加控制信息）通过水平虚线直接传递给对方
- 协议的水平
  - 各层协议实际上就是在各个对等层之间传递数据时的各项规定
- 服务的垂直
  - 在协议的控制下，两个对等实体之间的通信使得本层能够向**上一层**提供服务

封装

- 应用数据沿协议栈向下流动
- 在每层都会附加相应的首部
- 首部中最重要的信息之一是地址
  - 除此之外还有各种控制信息
  - 每层协议使用的地址不同
- 首部只能由对等层实体拆除

网络中的几类地址

- 物理地址
  - 网络接口层（链路层和物理层）使用，主要指以太网使用的 MAC 地址
- 逻辑地址
  - 网络层使用，IP 地址
- 端口地址
  - 传输层使用
  - 定位主机上的进程
- 域名地址
  - 应用层使用
  - 层次化，符号化地址
  - 解决 IP 地址难记和难使用的问题，无法直接用于计算机通信
  - 使用时需要域名映射到 IP 地址（DNS）
- 关系
  ![1701005501844](images/1701005501844.png)

网络中通信双方的进程标识

- IP 地址+端口号
- 网络中双方的通信可以用（本地 IP、本地端口、远程 IP、远程端口）

## 1 网络层

### 1.1 网络应用体系结构

- 客户机/服务器结构（C/S）
  - 服务器
    - 7\*24 小时提供服务
    - 永久性访问地址/域名
    - 利用大量服务器实现可拓展性
  - 客户机
    - 与服务器通信，使用服务器提供的服务
    - 间歇性接入网络
    - 可能使用动态 IP 地址
    - 不会与其他客户机直接通信
  - 集中管理方便、客户机之间不直接通信、可拓展性不佳
- P2P 结构
  - 没有永远在线的服务器
  - 任意端系统/节点之间可以直接通信
  - 节点间歇性接入网络
  - 节点可能改变 IP 地址
  - 优点：高度可伸缩
  - 缺点：难以管理
- 混合结构
  - 文件传输用 P2P 结构
  - 文件搜索用 C/S 结构
    - 每个节点向中央服务器登记自己的内容
    - 每个节点向中央服务器提交查询请求

### 1.2 网络应用进程通信

进程

- 主机上运行的程序
- 客户机进程：发起通信的进程
- 服务器进程：等待通信的进程
- 进程通信
  - 同一主机：进程间通信机制，操作系统提供
  - 不同主机：消息交换
- 用 IP 地址+端口号标识，进程寻址

套接字：同一主机内应用层与传输层之间的接口，可以向网络发送报文、接收报文

- 传输协议的选择
- 参数设置

应用层协议

- 网络应用需要遵循的应用层协议
- 公开协议
  - 由 RFC 定义
  - 允许互操作
- 私有协议
  - P2P 文件共享应用
- 协议内容
  - 消息的类型
    - 请求消息
    - 响应消息
  - 消息的语法
    - 字段及其描述
- 字段的语义
- 规则
  - 何时发送/相应消息
  - 如何发送/相应消息

网络应用对传输服务的需求

- 可靠的数据传输
- 安全性
- 时间
- 吞吐量/带宽

Internet 提供的传输服务

- TCP
  - 面向连接
  - 可靠数据传输
  - 流量控制
  - 拥塞控制
  - 不提供时间保障
  - 不提供最小带宽保障
- UDP
  - 无连接
  - 不可靠
  - 只提供差错检查和复用/分用

### 1.3 Web 应用

#### 1.3.1 web 构成

网页、网页相互链接

网页包含多个对象

- 对象：HTML 文件、图片、视频文件、动态脚本等
- 基本 HTML 文件：包含对其他对象引用的链接

对象的寻址

- URL：统一资源定位器
  - 格式
    Scheme://host:port/path

Web 应用遵循 HTTP 协议（超文本传输协议）

#### 1.3.2 HTTP 协议

采用 C/S 结构

- 客户-Browser：请求、接受、展示 Web 对象
- 服务器-Web Server：相应客户请求、发送对象

版本

- 1.0
- 1.1

使用 TCP 传输服务

- 服务器在 80 端口等待客户请求
- 浏览器发起到服务器的 TCP 链接（创建套接字）
- 服务器接受来自浏览器的 TCP 链接
- 浏览器与服务器交换 HTTP 消息
- 关闭 TCP 链接

无状态服务

- 服务器不维护任何有关客户端过去所发请求的信息

连接类型

- 非持久性连接 1.0 版本
  - 每个 TCP 连接最多传输一个对象
  - 每个对象需要两个 RTT
  - 响应时间
    - 发起、建立 TCP 连接：一个 RTT
    - 发送 HTTP 请求消息到响应消息的前几个字节到达：一个 RTT
    - 文件传输时间
    - total=2RTT+文件发送时间
- 持久性连接：每个 TCP 连接允许传输多个对象 1.1 版本
  - 不带流水线
    - 每个对象耗时 1 个 RTT
  - 带流水线（缺省模式）
    - 理想情况下，收到所有对象只需耗时约一个 RTT

HTTP 消息格式

- 请求报文
  - 请求行：方法、URL、版本\n\r
  - 请求头：每行都是头部域名称、头部域值\n\r
  - 请求体：请求数据。与请求头之间用\n\r 隔开，请求行和请求头之间不用
- 响应报文
  - 相应行：版本、状态码、原因短语
  - 请求头：与请求报文相同
  - 响应数据

请求方法

- POST
- GET
- HEAD，没有响应数据的 GET
- PUT，上传文件，1.1 版本才有
- DELETE，删除文件，1.1 版本才有

响应状态码

- 200 OK，正常
- 301 Moved Permanently，重定向
- 400 Bad Request，请求中缺少必须信息
- 404 Not Found，请求资源不存在
- 505 HTTP Version Not Supported

Cookie 技术

- HTTP 无状态，但是很多应用要求服务器掌握客户端状态
- 作用
  - 身份认证
  - 购物车
  - 推荐
- 风险
  - 信息泄露
- 组件
  - HTTP 响应消息的 cookie 头部行
  - HTTP 请求消息的 cookie 头部行
  - 保存在客户端主机上的 cookie 文件，由浏览器管理
  - Web 服务器后台数据库

Web 缓存/代理服务器技术

- 功能

  在不访问服务器的前提下满足客户端的 HTTP 请求
- 好处

  - 缩短客户请求时间
  - 减少组织流量
  - 在大范围内实现有效的内容分发
- 运行流程

  - 用户设定浏览器通过代理服务器进行 Web 访问
  - 代理服务器接收到用户请求
    - 如果请求对象在缓存中，直接返回缓存对象
    - 否则，向原始服务器发送 HTTP 请求，获取对象并返回给客户端同时缓存下来
- 代理服务器级充当客户端，也充当服务端，一般由 ISP 架设
- 缓存的更新

  - 如果缓存是最新版本，则直接返回
  - 在 HTTP 请求消息中加入 If-modified-since:\<date\>
  - 根据返回的状态码判断是否是最新版本：304 Not Modified

### 1.4 Email 应用

Email 应用的构成

- 邮件客户端（用户代理）
  - 进行邮件撰写和编辑
- 邮件服务器
  - 发送、接收邮件、维护用户邮箱
- 电子邮件所需协议
  - SMTP、POP3

电子邮件传输协议

- SMTP 协议

  - 发送电子邮件，不涉及邮件管理
  - 一般不使用中间邮件服务器进行连接
  - 使用 TCP 进行 email 消息的可靠传输
  - 使用端口 25
  - 传输过程的三个阶段

    - 握手
    - 消息传输
    - 关闭
  - 命令/响应交互模式

    - 命令：ASCII 文本
    - 响应：状态代码和语句
  - Email 消息只能包含 7 位 ASCII 码
  - 与 HTTP 对比

    ![1701010821485](images/1701010821485.png)
  - Email 消息格式

    - 头部行
      - To
      - From
      - Subject
    - 消息体
      - 消息本身
      - 只能是 ASCII 字符
    - 针对多媒体的拓展，MIME
      - 通过在邮件头部增加额外的行声明 MIME 的内容类型

电子邮件访问协议

- POP
  - 认证过程
    - 客户端命令
      - User：用户名
      - Pass：密码
    - 服务器响应
      - +OK
      - -ERR
  - 事务阶段
    - List：列出消息数量
    - Retr：用编号获取消息
    - Dele：删除消息
    - Quit
  - 下载并删除：如果用户换了客户端软件，无法重读邮件
  - 下载并保持：不同客户端都可以保留消息的拷贝
  - POP3 是无状态的
  - 端口号：110
- IMAP
  - 所有消息统一保存在服务器
  - 允许客户利用文件夹组织消息
  - 支持跨会话的用户状态
    - 文件夹的名字
    - 文件夹与消息 ID 之间的映射
- HTTP

### 1.5 DNS

DNS（Domain Name System）

- 功能

  - 解决 Internet 上主机/路由器的识别问题
  - 域名到 IP 地址的映射
- 性质

  - 多层命名服务器构成的分布式数据库

    - 根域名服务器
    - 顶级域名服务器：负责 com, org, net,edu 等顶级域名和国家顶级域名
    - 权威域名服务器：组织的域名解析服务器，提供组织内部服务器的解析服务
    - 本地域名解析服务器
      - 不严格属于层次体系
      - 每个 ISP 都有一个本地域名解析服务器
      - 当主机进行 DNS 查询时，查询被发送到本地域名服务器
  - 应用层协议：完成对域名的解析
- DNS 服务

  - 域名向 IP 地址的转换
  - 主机别名
  - 邮件服务器别名
  - 负载均衡
- 为什么不采用集中式 DNS

  - 单点失败问题
  - 流量问题
  - 距离问题
  - 维护性问题
- 分布式缺点

  - 多段访问，消耗时间和资源
- DNS 查询

  - 迭代式查询

    ![1701011699046](images/1701011699046.png)
  - 递归查询

    ![1701011713659](images/1701011713659.png)
- DNS 缓存-只要 DNS 服务器获得域名-IP 映射，即缓存这一映射

  - 一段时间后缓存失效
  - 本地域名服务器一般会缓存顶级域名服务器的映射，因此根域名服务器不经常被访问
- DNS 记录，资源记录 RR(name,value,type,ttl)

  - type=A
    - Name：主机域名
    - Value：IP 地址
  - type=B
    - Name：域（edu.cn）
    - Value：该域权威域名解析服务器的主机域名
  - type=CNAME
    - Name：某一真实域名的别名
    - Value：真实域名
  - type=MX
    - Value 是别名为 name 的邮件服务器的规范主机名
  - ttl：该记录的生存时间
- DNS 协议与消息

  - DNS 报文：请求报文和响应报文相同格式

    ![1701012251612](images/1701012251612.png)
- 一个域名可以对应于多个 IP，主机有多个网卡
- 一个 IP 也可以对应于不同的域名

### 1.6 P2P 应用

纯 P2P 架构

- 没有服务器
- 任意端系统之间直接通信
- 节点阶段性接入 Internet
- 节点可能更换 IP 地址

以文件分发为例

- 一个服务器向 N 个节点分发一个文件需要多长时间

  ![1701072342293](images/1701072342293.png)
- 假设

  - $u_s$：服务器上传带宽
  - $u_i$：节点$i$的上传带宽
  - $d_i$：节点$i$的下载带宽
- C/S 结构

  - 服务器串行发送 N 个副本，$NF/u_s$
  - 客户机$i$需要$F/d_i$时间下载
  - 总共时间$\max{\{NF/u_s,F/\min{d_i}\}}$
- P2P 结构

  - 服务器必须发送一个副本，$F/u_s$
  - 客户机$i$需要$F/d_i$时间下载
  - 总共需要下载$NF$
  - 最快的可能上传速率：$u_s+\sum{u_i}$
  - 总共时间$\max{\{F/u_s,F/\min{d_i},NF/(u_s+\sum{u_i})\}}$

P2P 协议-BitTorrent

- 每个文件划分为 256KB 的 chunk
- 有一个 tracker 跟踪参与 torrent 的节点
- torrent：交换同一个文件的文件快的节点组
- 工作流程
  - 文件划分为 256KB 的 chunk
  - 节点加入 torrent
    - 初始时没有 chunk，但是会逐渐累积
    - 向 tracker 注册以获取节点清单，与某些节点建立连接
  - 节点获取 chunk
    - 在任一时刻，不同节点拥有文件的不同 chunk 集合
    - 节点定期查询每个邻居所持有的 chunk 列表
    - 节点发送请求，请求获取确实的 chunk-稀缺优先：针对没有的块在邻居中决定最稀缺（副本数最少）的块来请求
  - 节点发送 chunk：tit-for-tat
    - 向正在向其发送 chunk 的邻居中选择速度最快的 4 个发送 chunk：每十秒重新评估 top4
    - 每 30 秒随机选择一个其他节点向其发送 chunk，这个节点可能加入 top4

P2P 索引技术

- 信息到节点位置（IP 地址+端口号）的映射
- 集中式索引
  - 节点加入时，通知中央服务器自身的 IP 地址和内容
  - 节点查找文件时，向中央服务器发出查询，返回拥有文件的节点的地址
  - 节点向拥有文件的节点发出请求
  - 内容和文件传输是分布式的，但是内容定位是高度集中式的
    - 单点失效问题
    - 性能问题
    - 版权问题
- 洪泛式查询
  - 采用完全分布式架构，每个节点只对它共享的文件进行索引
  - 查询
    - 查询信息通过已有的 TCP 连接发送
    - 节点转发查询信息
    - 如果查询命中则利用反向路径发回查询节点，使用 HTTP 传输文件
- 层次式覆盖网络
  - 介于集中式索引和洪泛式查询之间的方法
  - 每个节点或者是一个超级节点，或者被分配一个超级节点
    - 节点和超级节点之间维持 TCP 连接
    - 某些超级节点之间维持 TCP 连接
    - 超级节点负责跟踪子节点的内容

### 1.7 Socket 编程（略）

### 1.8 课上补充内容

#### 1.8.1 FTP（文件传输协议）

- 功能
  - 提供不同种类主机系统之间的文件传输能力
  - 以用户权限管理方式提供用户对远程 FTP 服务器上的文件管理能力
  - 以匿名 FTP 方式提供共用文件共享的能力
- 采用 C/S 的工作方式
- 使用 TCP 提供可靠数据传输服务
- 一个 FTP 服务器进程可以同时为多个客户进程提供服务。FTP 服务器进程由两大部分组成：一个主进程，负责接受新的请求；若干从属进程，处理单个请求
- 工作步骤
  - 服务器在 21 端口启动 FTP 服务（控制端口），等待客户端连接
  - 接受请求，启动从属进程处理客户进程发来的请求，主进程和从属进程并发执行
  - 传输完毕后由服务器关闭数据连接
- FTP 服务器维护状态：当前目录，身份认证
- FTP 在工作时使用两个并行的 TCP 连接：一个是控制连接（端口 21），一个是数据连接（端口 20）
  - 控制连接
    - 用来传递控制信息，控制信息以 7 位 ASCII 码传送
    - 在整个会话期间一直保持打开状态
  - 数据连接
    - 服务器的控制进程收到 FTP 请求后就创建数据传送进程和数据连接
    - 数据连接用来连接客户端和服务器端的数据传送进程
    - 数据连接有两种模式
      - 主动模式 POST：服务器使用 20 端口连接到用户的指定端口（客户端随机选择）
      - 被动模式 PASV：客户端使用端口连接到服务器的指定端口（服务器随机选择）
- 允许客户指明文件类型和格式

#### 1.8.2 DNS 攻击

- DDOS 攻击
  - 用流量轰炸根服务器
    - 从未成功
      - 流量过滤
      - 本地 DNS 缓存顶级域名服务器 IP，导致绕过根服务器
  - 轰炸顶级域名服务器
    - 可能更危险
- 重定向攻击
  - man-in-middle
    - 拦截查询
  - DNS poisoning（DNS 污染）
    - 发送虚假的应答到 DNS 服务器
- 利用 DNS 实施 DDoS
  - 使用欺骗性源地址发送查询

#### 1.8.3 视频流和内容分发网

因特网视频

- 视频：以恒定速率显示的图像序列
- 数字图像：像素陈列
  - 每位像素表示为若干比特
- 编码：在图像内部和图像之间使用冗余减少图像编码位数
  - 空间：对重复值的压缩
  - 时间：传输与上一帧的差异

HTTP 流和 DASH

- HTTP 流：请求视频时，客户端收到视频就播放同时缓存后面的视频
  - 缺点：所有客户收到相同编码的视频，没有考虑不同用户之间的差异
- DASH：经 HTTP 的动态适应性流
  - 服务器端
    - 将视频文件划分为块
    - 每个块以不同的速率存储、编码
    - 清单文件：为每个块提供 URL
  - 客户端
    - 定期测量服务器到客户端的带宽
    - 查阅清单文件，一次请求一个块
      - 基于当前带宽、选择可持续的最大编码速率
      - 可以在不同时间点选择不同的编码速率

内容分发网 CDN

- 如何将内容流式传输到数十万并发客户

  - 单个巨大的服务器
    - 单点故障
    - 网络拥塞点
    - 距离问题
    - 重复发送
    - 无法拓展
  - 在多个地理位置分散的站点上提供多个视频副本 CDN
- CDN 部署原则

  - 深入：将 CDN 服务器深入到多个接入网
  - 带回家：在接入网附近的接入点部署少量较大的服务集群
- CDN 操作

  ![1701077101099](images/1701077101099.png)
- 集群选择策略，CDN 的核心

## 2 传输层

### 2.1 传输层服务

传输层服务和协议

- 传输层协议为运行在不同主机上的进程提供了一种逻辑通信机制
- 端系统运行传输层协议
- 传输层可以为应用提供多种协议
  - TCP
    - 可靠、按序
    - 拥塞控制
    - 流量控制
    - 连接建立
    - 不提供广播和组播
  - UDP
    - 不可靠
  - 这两种服务均不保证延迟和带宽
- 与网络层的区别
  - 逻辑通信机制
    - 网络层：主机之间
    - 传输层：应用进程之间
- 与网络层联系
  - 位于网络层之上
  - 依赖于网络层服务
  - 对网络层服务进行（可能的）增强

### 2.2 复用和分用

如果某层的一个协议对应上层的多个协议/实体，需要进行多路复用和分用

接收端进行多路分用，发送端进行多路复用

- 复用
  - 从应用层接受数据，为每个数据分装头部信息，交给网络层
- 分用
  - 从网络层接收数据，根据头部信息将数据交付正确的 Scoket
  - 无连接分用-UDP
    - 用二元组（目的 IP 地址，目的端口号）标识 Scoket
    - 不同来源的数据被导向同一个 Scoket
  - 面向连接的分用-TCP
    - 用四元组（源 IP 地址，源端口号，目的 IP 地址，目的端口号）标识 Scoket
    - 为每一个不同来源的数据创建 Scoket
    - 多线程 Web 服务器

### 2.3 无连接传输协议-UDP

UDP

- 基于 IP 协议

  - 复用/分用
  - 简单的错误校验
- 尽力而为服务

  - 丢失分组
  - 不是按序到达
- 无连接
- 存在原因

  - 不用建立连接（减少延迟）
  - 实现简单：无需维护连接状态
  - 头部开销少
  - 没用拥塞控制：应用可以更好的控制发送时间和速率
- 应用

  - 流媒体
  - DNS
  - SNMP
- 在 UDP 上实现可靠数据传输

  - 在应用层增加可靠机制
  - 应用特定的错误恢复机制
- 报文段格式

  ![1701079503353](images/1701079503353.png)
- UDP 校验和

  - 计算校验和时需要在 UDP 数据报前加上 12B 的伪首部
  - 高位进位需要回卷
  - 校验和全 0 代表不适用校验和，如果计算出来恰好全 0 则填充全 1

### 2.4 可靠数据传输基本原理

_注：王道把这一部分和后面滑动窗口协议放在数据链路层。_

可靠：不错，不丢，不乱

#### 2.4.1 Rdt1.0

底层信道完全可靠

- 不会发生错误
- 不会丢弃分组

![1701080142271](images/1701080142271.png)

#### 2.4.2 Rdt2.0（ARQ）

底层信道可能出现位错误

- 利用校验和检测

错误恢复机制

- 确认机制：接收方显式地告诉发送方愤俗已被正确接收
- NAK：接收方显式地告诉发送方有错误
- 发送方收到 NAK 后，重传分组

![1701080361241](images/1701080361241.png)

#### 2.4.3 Rdt2.1

增加序列号，应对 ACK/NAK 消息被破坏导致的重复分组

发送方

![1701080488567](images/1701080488567.png)

接收方：接收到错误的序列号时也要发送 ACK，但不向上层交付

![1701080547086](images/1701080547086.png)

#### 2.4.4 Rdt2.2

不使用 NAK 的 Rdt2.1

![1701080692568](images/1701080692568.png)

#### 2.4.5 Rdt3.0

添加定时器

发送方

![1701080750486](images/1701080750486.png)

接收方，和 Rdt2.2 一样

性能很差

### 2.5 滑动窗口协议

滑动窗口协议

- 窗口

  - 允许使用的序列号范围
  - 窗口尺寸为 N：最多有 N 个等待确认的消息
- 滑动窗口

  - 随着协议的运行，窗口在序列号空间内向前滑动
- 滑动窗口协议

  - GBN

    - 分组头添加 k 位序列号
    - 窗口尺寸为 N，最多允许 N 个分组未确认
    - 采用**累计确认**机制
    - 为窗口设置计时器，超时重传所有未确认分组
    - 接收方只接受当前想要的分组，乱序的直接丢弃
  - SR

    - 在 GBN 的基础上，为每个发送但未确认分组设置计时器
    - 分组计时器超时，重传这一分组
    - 接收方也维护一个窗口，在窗口内的乱序到达分组缓存，等待前序确认之后一并交付
    - 发送方针对 ACK 也采用和接收方类似的缓存机制
    - 窗口大小与序列号长度的关系

      ![1701081485698](images/1701081485698.png)

      窗口长度必须小于等于序列号长度的一半（这里假设发送方和接收方窗口大小一样，如果不一样就是相加小于序列号长度），否则会出现上图的困境

### 2.6 面向连接传输协议-TCP

#### 2.6.1 TCP 协议

- 点对点协议
  - 一个发送方，一个接收方
- 可靠的按序的字节流
- 流水线机制
  - TCP 的拥塞控制和流量控制机制设置窗口尺寸（可动态调整）
- 发送方/接收方缓存，类似 SR
- 全双工
  - 同意连接能双向传递数据流
- 面向连接
  - 通信双方在发送数据之前必须建立连接
  - 连接状态旨在两端维护，中间节点不维护状态
  - TCP 连接包括：两台主机上的缓存、连接状态变量、socket 等
- 流量控制机制

#### 2.6.2 TCP 段结构

![1701083285718](images/1701083285718.png)

- 序列号
  - 指的是 segment 中第一个字节的编号，不是 segment 的编号
  - 建立连接时，双方随机选择初始序列号
- ACKs
  - 希望收到的下一个字节的序号
  - 采用累计确认机制
- 对于乱序到达的 segment 没有做出规定

#### 2.6.3 TCP 的可靠数据传输

- 流水线机制
- 累计确认
- 使用单一重传计时器
- 触发重传的事件
  - 超时
  - 重复 ACK
- 如何设置超时时间
  - 大于 RTT
  - 过短：不必要的重传
  - 过长：对丢失反应时间慢
- 如何估计 RTT
  - EstimatedRTT 估计：采样测量 SampleRTT，指数加权移动平均
    $EstimatedRTT=(1-\alpha)\times EstimatedRTT+\alpha\times SampleRTT$
- 定时器超时时间的设置
  - EstimatedRTT+安全边界：EstimatedRTT 变化大意味着要更大的边界
    $DevRTT=(1-\beta)\times DevRTT+\beta\times |SampleRTT-EstimatedRTT|\\TimeoutInterval=EstimatedRTT+4\times DevRTT$
- 一般来说，$\alpha=0.125,\beta=0.25$
- 快速重传机制
  - 收到重复三次及以上的 ACK，假定其后的段已经丢失，进行重传
  - 在定时器超时前重传

#### 2.6.4 TCP 的流量控制

- 接收方为 TCP 连接分配 buffer，上层应用处理 buffer 数据速度可能较慢
- 流量控制旨在控制发送方发送速率使得发送方不会传输太多数据淹没接收方
- 速度匹配机制
  - 接收方在 TCP 段头部将自己 buffer 剩余空间大小告知发送方
  - 需要注意：接收方告知接收窗口的大小是在接收方当前已经接受的数据的基础上得出的，并不意味着发送方接受到一个窗口大小就可以再发送这一大小的数据。**_24 王道 P231 28 题_**

#### 2.6.5 TCP 性能分析

忽略慢启动

![1701085977206](images/1701085977206.png)

公平性

![1701086076364](images/1701086076364.png)

公平性是针对 TCP 连接来说的，如果一个应用同时建立多个 TCP 连接，可能会导致应用层面的不公平

#### 2.6.5 TCP 连接管理

三次握手、四次挥手。重点注意序列号和 ack 的变化

建立连接

![1701084831522](images/1701084831522.png)

关闭连接

![1701084849626](images/1701084849626.png)

### 2.7 拥塞控制原理

拥塞控制的方法

- 端到端拥塞控制
  - 网络层不需要显式的提供支持
  - 端系统通过观察 loss，delay 等网络行为判断是否发生拥塞
- 网络辅助的拥塞控制
  - 路由器显式地反馈网络拥塞信息

### 2.8 TCP 拥塞控制

拥塞控制算法

- 慢启动
- 拥塞避免
- 快重传
- 快恢复

超时采用慢启动和拥塞避免

- 拥塞窗口未达到阈值时，指数增加
- 达到阈值后，线性增加
- 超时，新的阈值为超时时拥塞窗口大小的一半，拥塞窗口变为 1
- 重复

冗余 ACK 采用快重传和快恢复

- 前面一样
- 检测到冗余 ACK，快速重传，阈值减小为当前窗口一半，拥塞窗口变为新阈值
- 线性增加

实际发送窗口大小是接收窗口和拥塞窗口的最小值

### 2.9 补充内容

#### 2.9.1 糊涂窗口综合征

发送端发送的数据携带的实际数据很少，大部分都是头部

比如，接收端读取窗口中的数据很慢，接收窗口很快被填满，发送方不再发送数据。接收端应用层由于读数据很慢，每次只读一个字节，然后接收端通告大小为 1 的窗口，发送端发送一个字节，周而复始。这样虽然窗口很大，但是数据传输效率很低。

解决方法

- 接收端
  - Nagle 算法：报文一定长度再发送
- 接收端
  - Clark 方法：0 窗口确认
  - 延迟确认：阻止发送窗口滑动

#### 2.9.2 TCP 连接控制补充

![1701086565918](images/1701086565918.png)

![1701086575642](images/1701086575642.png)


<div STYLE="page-break-after: always;"></div>

## 夹带私货

**识之律者女士万岁！**

![1701088984915](images/1701088984915.jpg)
